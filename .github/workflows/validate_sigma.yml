name: Detection Rule Validation Pipeline

# The 'on' block defines the trigger events for this workflow.
on:
  push:
    branches: [ "main" ] # Runs when code is pushed directly to the main branch
  pull_request:
    branches: [ "main" ] # Runs when a Pull Request targets the main branch

jobs:
  lint_rules:
    name: 1. Validate Rule Syntax
    runs-on: ubuntu-latest # The type of virtual machine environment to run on
    
    steps:
    - name: Checkout Repository
      # This action brings your code from GitHub into the worker environment
      uses: actions/checkout@v4

    - name: Set up Python Environment
      # This action sets up the Python version required for our tools
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies
      # Create and install dependencies into a virtual environment (venv)
      # This is the most reliable way to ensure the interpreter finds the modules.
      run: |
        echo "Creating and installing dependencies into venv..."
        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt

    - name: Run yamllint on Sigma Rules Directory
      # Activate venv before running the executable to ensure it is in the PATH
      run: |
        source venv/bin/activate
        echo "Running yamllint across the 'rules/' directory..."
        # We use the '--strict' flag to enforce best practices
        yamllint --strict rules/

  # --- NEW JOB: Translate Sigma Rules ---
  translate_to_splunk:
    name: 2. Translate to Splunk SPL
    runs-on: ubuntu-latest
    needs: [lint_rules] # This job only runs if lint_rules successfully completed
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies
      # Create and install dependencies into a virtual environment (venv)
      run: |
        echo "Creating and installing dependencies into venv..."
        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        
    - name: Create Output Directory for Queries
      run: mkdir -p queries/splunk

    - name: Run pySigma Conversion Script
      # Activate venv and run the module
      run: |
        source venv/bin/activate
        echo "Translating Sigma rules to Splunk SPL..."
        # Using 'python3 -m pysigma' is the most robust execution method, 
        # now guaranteed to find the module inside the active venv.
        python3 -m pysigma convert \
          --target splunk \
          --output-path queries/splunk \
          rules/

    - name: Upload Translated Queries as Artifact
      # This step saves the translated Splunk queries so they can be downloaded
      # from the GitHub Actions run summary, making the output accessible.
      uses: actions/upload-artifact@v4
      with:
        name: splunk-detection-queries
        path: queries/splunk/
        retention-days: 7
