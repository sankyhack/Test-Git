name: Detection Rule Validation Pipeline

# The 'on' block defines the trigger events for this workflow.
on:
  push:
    branches: [ "main" ] # Runs when code is pushed directly to the main branch
  pull_request:
    branches: [ "main" ] # Runs when a Pull Request targets the main branch

jobs:
  lint_rules:
    name: 1. Validate Rule Syntax
    runs-on: ubuntu-latest # The type of virtual machine environment to run on
    
    steps:
    - name: Checkout Repository
      # This action brings your code from GitHub into the worker environment
      uses: actions/checkout@v4

    - name: Set up Python Environment
      # This action sets up the Python version required for our tools
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies
      # FIX: Explicitly use the venv's pip executable for installation.
      run: |
        echo "Creating and installing dependencies into venv..."
        python3 -m venv venv
        # Use ./venv/bin/pip to ensure installation is isolated and targeted
        ./venv/bin/pip install -r requirements.txt
        # Verification step: Confirm pysigma is installed
        echo "Verification: Installed packages in venv:"
        ./venv/bin/pip list | grep pysigma

    - name: Run yamllint on Sigma Rules Directory
      # Continue to use the explicit venv executable path
      run: |
        echo "Running yamllint across the 'rules/' directory..."
        ./venv/bin/yamllint --strict rules/

  # --- NEW JOB: Translate Sigma Rules ---
  translate_to_splunk:
    name: 2. Translate to Splunk SPL
    runs-on: ubuntu-latest
    needs: [lint_rules] # This job only runs if lint_rules successfully completed
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies
      # FIX: Explicitly use the venv's pip executable for installation.
      run: |
        echo "Creating and installing dependencies into venv..."
        python3 -m venv venv
        # Use ./venv/bin/pip to ensure installation is isolated and targeted
        ./venv/bin/pip install -r requirements.txt
        # Verification step: Confirm pysigma is installed
        echo "Verification: Installed packages in venv:"
        ./venv/bin/pip list | grep pysigma
        
    - name: Create Output Directory for Queries
      run: mkdir -p queries/splunk

    - name: Run pySigma Conversion Script
      # Continue to use the explicit venv executable path
      run: |
        echo "Translating Sigma rules to Splunk SPL..."
        ./venv/bin/python3 -m pysigma convert \
          --target splunk \
          --output-path queries/splunk \
          rules/

    - name: Upload Translated Queries as Artifact
      # This step saves the translated Splunk queries so they can be downloaded
      # from the GitHub Actions run summary, making the output accessible.
      uses: actions/upload-artifact@v4
      with:
        name: splunk-detection-queries
        path: queries/splunk/
        retention-days: 7
