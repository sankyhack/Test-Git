name: Detection Rule Validation Pipeline

# The 'on' block defines the trigger events for this workflow.
on:
  push:
    branches: [ "main" ] # Runs when code is pushed directly to the main branch
  pull_request:
    branches: [ "main" ] # Runs when a Pull Request targets the main branch

jobs:
  lint_rules:
    name: 1. Validate Rule Syntax
    runs-on: ubuntu-latest # The type of virtual machine environment to run on
    
    steps:
    - name: Checkout Repository
      # This action brings your code from GitHub into the worker environment
      uses: actions/checkout@v4

    - name: Set up Python Environment
      # This action sets up the Python version required for our tools
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies and Update PATH
      # FIX: Install packages with --user and explicitly add the resulting binary path to GITHUB_PATH
      run: |
        echo "Installing Python dependencies..."
        pip install --user -r requirements.txt
        # Explicitly add the user's local binary directory to the PATH so yamllint is found.
        echo "$(python3 -m site --user-base)/bin" >> $GITHUB_PATH

    - name: Run yamllint on Sigma Rules Directory
      # Linting is the first and fastest check. It ensures all rule files are valid YAML.
      # If this fails, the pipeline stops immediately.
      run: |
        echo "Running yamllint across the 'rules/' directory..."
        # We use the '--strict' flag to enforce best practices
        yamllint --strict rules/

  # --- NEW JOB: Translate Sigma Rules ---
  translate_to_splunk:
    name: 2. Translate to Splunk SPL
    runs-on: ubuntu-latest
    needs: [lint_rules] # This job only runs if lint_rules successfully completed
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies and Update PATH
      run: |
        echo "Installing Python dependencies..."
        pip install --user -r requirements.txt
        # Explicitly add the user's local binary directory to the PATH so pysigma is found.
        echo "$(python3 -m site --user-base)/bin" >> $GITHUB_PATH
        
    - name: Create Output Directory for Queries
      run: mkdir -p queries/splunk

    - name: Run pySigma Conversion Script
      # We execute a command-line script using pySigma's built-in CLI tool.
      # This converts all rules in 'rules/' using the Splunk backend and saves them
      # to individual files in the 'queries/splunk' directory.
      run: |
        echo "Translating Sigma rules to Splunk SPL..."
        pysigma convert \
          --target splunk \
          --output-path queries/splunk \
          rules/

    - name: Upload Translated Queries as Artifact
      # This step saves the translated Splunk queries so they can be downloaded
      # from the GitHub Actions run summary, making the output accessible.
      uses: actions/upload-artifact@v4
      with:
        name: splunk-detection-queries
        path: queries/splunk/
        retention-days: 7
